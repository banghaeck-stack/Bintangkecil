<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINTANG KECIL Privat</title>
    <!-- Menggunakan Tailwind CSS untuk styling profesional -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Menggunakan Lucide Icons untuk ikon yang modern -->
    <script src="https://unpkg.com/lucide-react@0.321.0/dist/lucide-react.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Latar belakang abu-abu muda */
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        /* Style untuk scrollbar agar lebih modern */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animasi saat modal muncul */
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Style untuk tombol absensi */
        .attendance-btn.active {
            color: white;
            border-color: transparent;
        }
        .attendance-btn.active.present { background-color: #10B981; } /* Hijau */
        .attendance-btn.active.absen { background-color: #EF4444; } /* Merah */
        
        .attendance-btn:disabled {
            cursor: not-allowed;
            background-color: #e5e7eb;
            border-color: #d1d5db;
            color: #9ca3af;
            opacity: 0.7;
        }
        
        /* Style untuk Tab (Mobile) */
        .tab-btn.active {
            color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5; /* indigo-500 */
        }
        
        /* Style untuk Menu Sidebar (Desktop) */
        .menu-item.active, .submenu-item.active {
            background-color: #eef2ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
            font-weight: 600;
        }
        
        .menu-item-group-toggle.active-parent {
            background-color: #f4f4f5; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }

        /* Style untuk sidebar yang bisa disembunyikan */
        #sidebar {
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #main-layout.sidebar-collapsed #sidebar {
            width: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        /* Style untuk submenu */
        .submenu-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .submenu-container.open {
            max-height: 200px; /* Cukup besar untuk 3 item */
        }
        .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }
        .menu-item-group-toggle.active-parent .chevron-icon {
            transform: rotate(90deg);
        }

        /* Style untuk game */
        .game-card, .game-selection-card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out;
            border: 4px solid #E0F2FE; /* light blue border */
        }
        .game-card:hover, .game-selection-card:hover:not(:disabled) {
            transform: translateY(-5px);
        }
        .game-object-display {
            font-size: 3.5rem;
            line-height: 1;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            min-height: 100px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .game-option-btn {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .game-option-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .game-option-btn:active {
            transform: scale(0.95);
        }
        .correct-answer-animation {
            animation: game-shake 0.5s ease-in-out, game-glow 1s ease-in-out;
        }
        @keyframes game-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        @keyframes game-glow {
            0%, 100% { box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #E0F2FE; }
            50% { box-shadow: 0 0 30px rgba(74, 222, 128, 0.8); border-color: #4ADE80; }
        }
        #feedback-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #game-nav-container {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        #game-nav-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #wortel-game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .item-connector {
            cursor: pointer;
            user-select: none;
        }
        .item-connector.connected {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Halaman Login -->
    <div id="login-page" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Selamat Datang</h2>
            <p class="text-center text-gray-500 mb-8">Silakan masuk untuk melanjutkan.</p>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="flex items-center justify-between mt-4">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">
                            Ingat saya
                        </label>
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-600 mt-2 hidden"></p>
                <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Masuk</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <!-- Header Aplikasi -->
        <header class="mb-8 relative">
            <div class="flex items-center gap-4">
                <!-- Tombol untuk toggle menu -->
                <button id="menu-toggle-btn" class="hidden md:block p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-baseline gap-2">
                        <span>BINTANG KECIL</span>
                        <span class="text-xl font-medium text-indigo-600">Privat</span>
                    </h1>
                    <p id="user-role-display" class="text-gray-500 mt-1"></p>
                </div>
            </div>
             <!-- Tombol Logout -->
            <div class="absolute top-0 right-0">
                 <button id="logout-btn" class="flex items-center gap-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>Logout</span>
                 </button>
            </div>
        </header>
        
        <!-- Layout Utama dengan Sidebar -->
        <div id="main-layout" class="flex flex-col md:flex-row md:gap-8">

            <!-- Sidebar Menu (Desktop) -->
            <aside id="sidebar" class="hidden md:block md:w-1/4 lg:w-1/5">
                <div class="bg-white rounded-xl shadow-lg p-4 sticky top-8">
                    <nav id="side-menu" class="flex flex-col space-y-1">
                        <button data-tab="attendance" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/></svg>
                            <span>Absensi</span>
                        </button>
                        <button data-tab="agenda" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-todo"><rect x="3" y="5" width="6" height="6" rx="1"/><path d="m3 17 6 0"/><path d="m13 5 8 0"/><path d="m13 11 8 0"/><path d="m13 17 8 0"/></svg>
                            <span>Agenda</span>
                        </button>
                        <button data-tab="recap" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
                            <span>Rekap Absensi</span>
                        </button>
                        <button data-tab="laporan" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-text"><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M10 6h8"/><path d="M10 12h8"/><path d="M10 18h8"/></svg>
                            <span>Laporan Belajar</span>
                        </button>
                        
                        <!-- Menu Mari Belajar dengan Submenu -->
                        <div>
                            <button id="belajar-menu-toggle" class="menu-item-group-toggle flex items-center justify-between w-full gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                                <div class="flex items-center gap-3">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-graduation-cap"><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.084a1 1 0 0 0 0 1.838l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12v5a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3v-5"/></svg>
                                    <span>Mari Belajar</span>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                            <div id="belajar-submenu" class="submenu-container ml-5 mt-1">
                                <nav class="flex flex-col space-y-1">
                                    <button data-tab="belajar-huruf" class="menu-item submenu-item block w-full text-left p-2 rounded-md text-gray-600 hover:bg-gray-100">Mengenal Huruf</button>
                                    <button data-tab="game-lobby" class="menu-item submenu-item block w-full text-left p-2 rounded-md text-gray-600 hover:bg-gray-100">Aneka Permainan</button>
                                    <button data-tab="belajar-baca" class="menu-item submenu-item block w-full text-left p-2 rounded-md text-gray-600 hover:bg-gray-100">Belajar Membaca</button>
                                </nav>
                            </div>
                        </div>

                        <button data-tab="all-schedules" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span>Semua Jadwal</span>
                        </button>
                        <!-- Menu Pengaturan Akun (Hanya Admin) -->
                        <button data-tab="settings" id="settings-menu-item" class="menu-item flex items-center gap-3 p-3 rounded-lg text-left text-gray-600 hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span>Pengaturan Akun</span>
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- Konten Utama -->
            <main class="flex-1">
                <!-- Panel Kontrol -->
                <div id="main-controls" class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <button id="add-student-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        Tambah Jadwal Baru
                    </button>
                    <div class="flex flex-col sm:flex-row items-center gap-2 w-full sm:w-auto">
                        <select id="lesson-type-filter" class="w-full sm:w-40 bg-white border border-gray-300 text-gray-700 rounded-lg py-2 px-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="Semua">Semua Tipe</option>
                            <option value="Privat">Privat</option>
                            <option value="Grup">Grup</option>
                            <option value="Visit Home">Visit Home</option>
                        </select>
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="search-input" placeholder="Cari nama siswa/grup..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </div>
                    </div>
                </div>
                
                <!-- Navigasi Tab (Mobile) -->
                <div class="border-b border-gray-200 mb-6 md:hidden">
                    <nav id="tabs" class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="attendance" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Absensi</button>
                        <button data-tab="agenda" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Agenda</button>
                        <button data-tab="recap" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Rekap</button>
                        <button data-tab="laporan" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Laporan</button>
                        <button data-tab="belajar-huruf" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Huruf</button>
                        <button data-tab="game-lobby" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Games</button>
                        <button data-tab="belajar-baca" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Baca</button>
                        <button data-tab="all-schedules" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Semua</button>
                        <button data-tab="settings" id="settings-tab-item" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Pengaturan</button>
                    </nav>
                </div>
                
                <!-- Konten Tab -->
                <div id="tab-content">
                    <div id="attendance-view" class="tab-pane">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                            <h2 id="attendance-header" class="text-2xl font-bold text-gray-800">Absensi</h2>
                            <input type="date" id="attendance-date-picker" class="border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div id="attendance-list" class="bg-white rounded-xl shadow-lg p-6 space-y-4"></div>
                    </div>
                    <div id="agenda-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Agenda Minggu Ini</h2>
                        <div id="schedule-agenda" class="bg-white rounded-xl shadow-lg p-6"></div>
                    </div>
                    <div id="recap-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Rekap Absensi</h2>
                        <div id="recap-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    </div>
                    <div id="laporan-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Laporan Belajar</h2>
                        <div id="laporan-list" class="space-y-6"></div>
                    </div>
                    <!-- Halaman Mari Belajar -->
                    <div id="belajar-huruf-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Mengenal Huruf</h2>
                        <div id="huruf-container" class="grid grid-cols-5 sm:grid-cols-7 md:grid-cols-9 lg:grid-cols-13 gap-2"></div>
                    </div>
                    <div id="game-lobby-view" class="tab-pane hidden">
                        <div id="game-lobby">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pilih Permainan</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button data-game="berhitung" class="game-selection-card text-left p-6 cursor-pointer">
                                    <div class="text-4xl">🔢</div>
                                    <h3 class="font-bold text-xl mt-2 text-gray-800">Mari Berhitung</h3>
                                    <p class="text-gray-500 text-sm mt-1">Tebak jumlah benda dengan pilihan ganda.</p>
                                </button>
                                <button data-game="wortel" class="game-selection-card text-left p-6 cursor-pointer">
                                    <div class="text-4xl">🥕</div>
                                    <h3 class="font-bold text-xl mt-2 text-gray-800">Hubungkan Wortel</h3>
                                    <p class="text-gray-500 text-sm mt-1">Hubungkan jumlah wortel dengan angka yang tepat.</p>
                                </button>
                                <div class="game-selection-card text-left p-6 bg-gray-50 opacity-60">
                                    <div class="text-4xl">➕</div>
                                    <h3 class="font-bold text-xl mt-2 text-gray-800">Penjumlahan (Segera Hadir)</h3>
                                    <p class="text-gray-500 text-sm mt-1">Latihan menjumlahkan dua kelompok benda.</p>
                                </div>
                            </div>
                        </div>
                        <div id="game-active-view" class="hidden"></div>
                    </div>
                    <div id="belajar-baca-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Belajar Membaca</h2>
                        <div id="baca-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                    </div>
                    <div id="all-schedules-view" class="tab-pane hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Semua Jadwal</h2>
                        <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                        <div id="empty-state" class="hidden text-center py-16">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2 mx-auto text-gray-400"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="9" r="4"/><path d="M22 19a6 6 0 0 0-6-6 4 4 0 1 0 0-8"/></svg>
                            <h3 class="mt-4 text-xl font-semibold text-gray-700">Belum Ada Jadwal</h3>
                            <p class="text-gray-500 mt-1">Silakan tambahkan jadwal les baru untuk memulai.</p>
                        </div>
                    </div>
                     <!-- Halaman Pengaturan Akun -->
                    <div id="settings-view" class="tab-pane hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Form Tambah Pengguna -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tambah Pengguna Baru</h2>
                                <form id="user-form" class="space-y-4">
                                    <div>
                                        <label for="new-username" class="block text-sm font-medium text-gray-700">Username</label>
                                        <input type="text" id="new-username" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                                        <p id="username-hint" class="text-xs text-gray-500 mt-1 hidden">Untuk Orang Tua, gunakan nama lengkap siswa.</p>
                                    </div>
                                    <div>
                                        <label for="new-password" class="block text-sm font-medium text-gray-700">Password</label>
                                        <input type="password" id="new-password" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                                    </div>
                                    <div>
                                        <label for="new-role" class="block text-sm font-medium text-gray-700">Peran</label>
                                        <select id="new-role" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                                            <option value="Guru">Guru</option>
                                            <option value="OrangTua">Orang Tua</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Tambah Pengguna</button>
                                </form>
                            </div>
                             <!-- Daftar Pengguna -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Daftar Pengguna</h2>
                                <div id="user-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal untuk Tambah/Edit Siswa -->
    <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto modal-enter">
            <form id="student-form" class="p-8">
                <input type="hidden" id="student-id">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Tambah Jadwal Baru</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="sm:col-span-2">
                        <label for="lesson-type" class="block text-sm font-medium text-gray-700 mb-1">Tipe Les</label>
                        <select id="lesson-type" name="lesson-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="Privat">Privat</option>
                            <option value="Grup">Grup</option>
                            <option value="Visit Home">Visit Home</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="name" id="name-label" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                        <input type="text" id="name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Budi Santoso">
                    </div>
                    <div id="group-members-container" class="hidden sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="group-member-1" class="block text-sm font-medium text-gray-700 mb-1">Anggota 1</label>
                            <input type="text" id="group-member-1" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Anggota 1">
                        </div>
                        <div>
                            <label for="group-member-2" class="block text-sm font-medium text-gray-700 mb-1">Anggota 2</label>
                            <input type="text" id="group-member-2" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Anggota 2">
                        </div>
                        <div>
                            <label for="group-member-3" class="block text-sm font-medium text-gray-700 mb-1">Anggota 3</label>
                            <input type="text" id="group-member-3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nama Anggota 3">
                        </div>
                    </div>
                    
                    <div id="parent-account-creator" class="hidden sm:col-span-2 space-y-4 bg-indigo-50 p-4 rounded-lg">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="create-parent-account" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span id="create-account-label" class="ml-2 text-sm font-medium text-gray-700">Buatkan akun login untuk Orang Tua</span>
                            </label>
                        </div>
                        <div id="parent-password-fields" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="parent-password" class="block text-sm font-medium text-gray-700">Password Akun</label>
                                <input type="password" id="parent-password" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                            </div>
                            <div>
                                <label for="parent-confirm-password" class="block text-sm font-medium text-gray-700">Konfirmasi Password</label>
                                <input type="password" id="parent-confirm-password" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm">
                            </div>
                        </div>
                        <p id="account-creation-error" class="text-sm text-red-600 hidden"></p>
                    </div>

                    <div class="sm:col-span-2">
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <input type="text" id="subject" name="subject" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: Matematika">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai Les</label>
                        <input type="date" id="start-date" name="start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="schedule-day" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                        <select id="schedule-day" name="schedule-day" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label for="schedule-time" class="block text-sm font-medium text-gray-700 mb-1">Jam</label>
                        <input type="time" id="schedule-time" name="schedule-time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Tulis catatan mengenai sesi les di sini..."></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Feedback untuk game -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transform scale-95">
        <div id="feedback-content" class="text-center bg-white rounded-2xl shadow-xl p-8 md:p-12">
            <p id="feedback-text" class="font-fredoka text-5xl md:text-6xl"></p>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Referensi Elemen DOM
    const studentList = document.getElementById('student-list');
    const addStudentBtn = document.getElementById('add-student-btn');
    const studentModal = document.getElementById('student-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const studentForm = document.getElementById('student-form');
    const modalTitle = document.getElementById('modal-title');
    const searchInput = document.getElementById('search-input');
    const emptyState = document.getElementById('empty-state');
    const scheduleAgenda = document.getElementById('schedule-agenda');
    const lessonTypeSelect = document.getElementById('lesson-type');
    const groupMembersContainer = document.getElementById('group-members-container');
    const nameLabel = document.getElementById('name-label');
    const nameInput = document.getElementById('name');
    const lessonTypeFilter = document.getElementById('lesson-type-filter');
    const attendanceListContainer = document.getElementById('attendance-list');
    const attendanceHeader = document.getElementById('attendance-header');
    const attendanceDatePicker = document.getElementById('attendance-date-picker');
    const tabsContainer = document.getElementById('tabs');
    const sideMenu = document.getElementById('side-menu');
    const tabPanes = document.querySelectorAll('#tab-content .tab-pane');
    const recapList = document.getElementById('recap-list');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const mainLayout = document.getElementById('main-layout');
    const mainControls = document.getElementById('main-controls');
    const loginPage = document.getElementById('login-page');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const logoutBtn = document.getElementById('logout-btn');
    const userRoleDisplay = document.getElementById('user-role-display');
    const loginError = document.getElementById('login-error');
    const userForm = document.getElementById('user-form');
    const userList = document.getElementById('user-list');
    const settingsMenuItem = document.getElementById('settings-menu-item');
    const settingsTabItem = document.getElementById('settings-tab-item');
    const newRoleSelect = document.getElementById('new-role');
    const usernameHint = document.getElementById('username-hint');
    const parentAccountCreator = document.getElementById('parent-account-creator');
    const createParentAccountCheckbox = document.getElementById('create-parent-account');
    const parentPasswordFields = document.getElementById('parent-password-fields');
    const accountCreationError = document.getElementById('account-creation-error');
    const createAccountLabel = document.getElementById('create-account-label');
    const laporanListContainer = document.getElementById('laporan-list');
    const hurufContainer = document.getElementById('huruf-container');
    const bacaContainer = document.getElementById('baca-container');
    const belajarMenuToggle = document.getElementById('belajar-menu-toggle');
    const belajarSubmenu = document.getElementById('belajar-submenu');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const feedbackModal = document.getElementById('feedback-modal');
    const feedbackText = document.getElementById('feedback-text');
    const gameLobby = document.getElementById('game-lobby');
    const gameActiveView = document.getElementById('game-active-view');
    
    // State Aplikasi
    let students = [];
    let users = [];
    let currentUserRole = '';
    let currentChildNameForParent = '';
    let debounceTimer;
    let currentQuestionIndex = 0;
    let gameQuestions = [];
    const daysOfWeek = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    
    const formatDateToYMD = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    }

    const speak = (text) => {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            window.speechSynthesis.speak(utterance);
        } else {
            console.warn('Browser Anda tidak mendukung fitur suara.');
        }
    };

    const loadData = () => {
        const storedStudents = localStorage.getItem('tutoring_students');
        if (storedStudents) students = JSON.parse(storedStudents);

        const storedUsers = localStorage.getItem('tutoring_users');
        if (storedUsers) {
            users = JSON.parse(storedUsers);
        } else {
            users = [{ username: 'admin', password: 'admin123', role: 'Admin' }];
            saveUsers();
        }
        
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (loggedInUser) {
            currentUserRole = loggedInUser.role;
            currentChildNameForParent = loggedInUser.childName || '';
            showApp();
        } else {
            showLogin();
        }
    };

    const saveStudents = () => localStorage.setItem('tutoring_students', JSON.stringify(students));
    const saveUsers = () => localStorage.setItem('tutoring_users', JSON.stringify(users));
    
    const showLogin = () => {
        loginPage.style.display = 'flex';
        appContainer.classList.add('hidden');
        const rememberedUser = localStorage.getItem('rememberedUser');
        if (rememberedUser) {
            const { username, password } = JSON.parse(rememberedUser);
            usernameInput.value = username;
            passwordInput.value = password;
            rememberMeCheckbox.checked = true;
        }
    };

    const showApp = () => {
        loginPage.style.display = 'none';
        appContainer.classList.remove('hidden');
        attendanceDatePicker.value = formatDateToYMD(new Date());
        applyRolePermissions();
        setActiveNav('attendance');
        showTabPane('attendance');
        updateUI();
    };
    
    const toggleModalFields = () => {
        const lessonType = lessonTypeSelect.value;
        parentAccountCreator.classList.remove('hidden'); 

        if (lessonType === 'Grup') {
            groupMembersContainer.classList.remove('hidden');
            nameLabel.textContent = 'Nama Grup';
            nameInput.placeholder = 'Contoh: Grup Ceria';
            createAccountLabel.textContent = 'Buatkan akun login untuk perwakilan Grup';
        } else { 
            groupMembersContainer.classList.add('hidden');
            nameLabel.textContent = 'Nama Siswa';
            nameInput.placeholder = 'Contoh: Budi Santoso';
            createAccountLabel.textContent = 'Buatkan akun login untuk Orang Tua';
        }
    };

    const applyRolePermissions = () => {
        const isOrangTua = currentUserRole === 'OrangTua';
        const isAdmin = currentUserRole === 'Admin';
        
        mainControls.style.display = isOrangTua ? 'none' : 'flex';
        
        let roleText = `Masuk sebagai: ${currentUserRole}`;
        if (isOrangTua) roleText += ` (Wali dari ${currentChildNameForParent})`;
        userRoleDisplay.textContent = roleText;

        document.querySelectorAll('[data-tab="agenda"]').forEach(el => el.style.display = isOrangTua ? 'none' : 'flex');
        document.querySelectorAll('[data-tab="all-schedules"]').forEach(el => el.style.display = isOrangTua ? 'none' : 'flex');
        settingsMenuItem.style.display = isAdmin ? 'flex' : 'none';
        settingsTabItem.style.display = isAdmin ? 'block' : 'none';

        if (isOrangTua) {
            const activeTab = document.querySelector('.menu-item.active')?.dataset.tab || 'attendance';
            if (['agenda', 'all-schedules', 'settings'].includes(activeTab)) {
                setActiveNav('attendance');
                showTabPane('attendance');
            }
        }
    };

    const renderUsers = () => {
        userList.innerHTML = '';
        if (users.length === 0) {
            userList.innerHTML = '<p class="text-gray-500">Belum ada pengguna.</p>';
            return;
        }
        users.forEach(user => {
            const userItem = `
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                    <div>
                        <p class="font-semibold text-gray-800">${user.username}</p>
                        <p class="text-sm text-gray-500">${user.role}</p>
                    </div>
                    ${user.username !== 'admin' ? `<button data-username="${user.username}" class="delete-user-btn text-red-500 hover:text-red-700">Hapus</button>` : ''}
                </div>`;
            userList.innerHTML += userItem;
        });
    };
    
    const renderRecap = () => {
        recapList.innerHTML = '';
        let studentsToRecap = students;
        if (currentUserRole === 'OrangTua') {
            studentsToRecap = students.filter(s => s.name.toLowerCase() === currentChildNameForParent.toLowerCase());
        }

        if (studentsToRecap.length === 0) {
            recapList.innerHTML = `<p class="text-gray-500 col-span-full text-center">${currentUserRole === 'OrangTua' ? 'Data rekap untuk siswa ini tidak ditemukan.' : 'Belum ada data siswa untuk direkap.'}</p>`;
            return;
        }

        studentsToRecap.forEach(student => {
            let totalPertemuan = 0;
            if (student.startDate) {
                const startDate = new Date(student.startDate + 'T00:00:00');
                const today = new Date();
                today.setHours(23, 59, 59, 999); 
                const scheduleDayName = student.schedule.split(',')[0].trim();
                const scheduleDayIndex = daysOfWeek.indexOf(scheduleDayName);
                if (scheduleDayIndex !== -1) {
                    let currentDate = new Date(startDate);
                    while (currentDate <= today) {
                        if (currentDate.getDay() === scheduleDayIndex) totalPertemuan++;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            }
            const attendanceCounts = { Present: 0, Absen: 0 };
            if(student.attendance) {
                student.attendance.forEach(att => {
                    if (att.status === 'Hadir' || att.status === 'Present') {
                        attendanceCounts.Present++;
                    } else {
                        attendanceCounts.Absen++;
                    }
                });
            }
            const pertemuanSiklus = totalPertemuan > 0 ? (totalPertemuan - 1) % 4 + 1 : 0;
            const persentaseHadir = totalPertemuan > 0 ? (attendanceCounts.Present / totalPertemuan) * 100 : 0;
            const recapCard = `
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 overflow-hidden">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${student.name}</h3>
                            <p class="text-sm text-gray-500">${student.subject}</p>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                             <p class="text-2xl font-bold text-indigo-600">${pertemuanSiklus}<span class="text-base text-gray-500 font-normal">/4</span></p>
                             <p class="text-xs text-gray-500">Sesi Siklus Ini</p>
                        </div>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <div class="flex justify-around text-center mb-4">
                            <div><p class="text-xl font-bold text-gray-700">${totalPertemuan}</p><p class="text-xs text-gray-500">Total Sesi</p></div>
                            <div><p class="text-xl font-bold text-green-600">${persentaseHadir.toFixed(0)}%</p><p class="text-xs text-gray-500">Kehadiran</p></div>
                        </div>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between items-center bg-green-50 p-2 rounded"><span>Present</span> <span class="font-semibold bg-green-200 text-green-800 px-2 py-0.5 rounded-full">${attendanceCounts.Present}</span></li>
                            <li class="flex justify-between items-center bg-red-50 p-2 rounded"><span>Absen</span> <span class="font-semibold bg-red-200 text-red-800 px-2 py-0.5 rounded-full">${attendanceCounts.Absen}</span></li>
                        </ul>
                    </div>
                </div>`;
            recapList.innerHTML += recapCard;
        });
    };

    const renderAttendance = (dateString) => {
        const selectedDate = new Date(dateString + 'T00:00:00');
        const selectedDateYMD = formatDateToYMD(selectedDate);
        const dayName = daysOfWeek[selectedDate.getDay()];
        const formattedDate = selectedDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
        attendanceHeader.textContent = `Absensi: ${formattedDate}`;
        
        let studentsForDate = students.filter(s => s.schedule && s.schedule.startsWith(dayName))
            .sort((a, b) => (a.schedule.split(',')[1]?.trim() || '00:00').localeCompare(b.schedule.split(',')[1]?.trim() || '00:00'));

        if (currentUserRole === 'OrangTua') {
            studentsForDate = studentsForDate.filter(s => s.name.toLowerCase() === currentChildNameForParent.toLowerCase());
        }

        attendanceListContainer.innerHTML = '';
        if (studentsForDate.length === 0) {
            attendanceListContainer.innerHTML = `<p class="text-gray-500">Tidak ada jadwal les pada tanggal ini.</p>`;
            return;
        }

        const isActionable = currentUserRole === 'Admin' || currentUserRole === 'Guru';
        studentsForDate.forEach(student => {
            const time = student.schedule.split(',')[1]?.trim() || '';
            const attendanceRecord = (student.attendance || []).find(att => att.date === selectedDateYMD);
            
            let displayStatus = null;
            if (attendanceRecord) {
                if (attendanceRecord.status === 'Hadir' || attendanceRecord.status === 'Present') {
                    displayStatus = 'Present';
                } else {
                    displayStatus = 'Absen';
                }
            }

            const buttons = ['Present', 'Absen'].map(status => {
                const isActive = displayStatus === status;
                const statusClass = status.toLowerCase();
                return `<button data-id="${student.id}" data-status="${status}" class="attendance-btn ${statusClass} ${isActive ? 'active' : ''} border rounded-md px-3 py-1 text-sm font-medium transition-colors" ${!isActionable ? 'disabled' : ''}>${status}</button>`;
            }).join('');
            const attendanceItem = `
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 rounded-lg border hover:bg-gray-50">
                    <div class="mb-2 sm:mb-0"><p class="font-bold text-gray-800">${student.name}</p><p class="text-sm text-gray-500">${student.subject} - ${time}</p></div>
                    <div class="flex items-center gap-2 flex-wrap">${buttons}</div>
                </div>`;
            attendanceListContainer.innerHTML += attendanceItem;
        });
    };
    
    const renderLaporan = () => {
        laporanListContainer.innerHTML = '';
        let studentsToReport = students;
        if (currentUserRole === 'OrangTua') {
            studentsToReport = students.filter(s => s.name.toLowerCase() === currentChildNameForParent.toLowerCase());
        }

        if (studentsToReport.length === 0) {
            laporanListContainer.innerHTML = '<p class="text-gray-500 text-center">Tidak ada siswa untuk ditampilkan.</p>';
            return;
        }

        const isEditable = currentUserRole === 'Admin' || currentUserRole === 'Guru';
        studentsToReport.forEach(student => {
            const reportItem = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800">${student.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">${student.subject}</p>
                    <textarea 
                        data-id="${student.id}" 
                        class="laporan-textarea w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                        rows="4" 
                        placeholder="Tulis laporan perkembangan belajar di sini..."
                        ${!isEditable ? 'readonly' : ''}
                    >${student.learningReport || ''}</textarea>
                </div>
            `;
            laporanListContainer.innerHTML += reportItem;
        });
    };
    
    const renderHuruf = () => {
        hurufContainer.innerHTML = '';
        for (let i = 65; i <= 90; i++) {
            const letter = String.fromCharCode(i);
            hurufContainer.innerHTML += `<button class="belajar-btn bg-white rounded-lg shadow p-4 text-2xl font-bold text-gray-700 hover:bg-indigo-100 transition-colors">${letter}</button>`;
        }
    };

    const renderBaca = () => {
        bacaContainer.innerHTML = '';
        const words = ['Buku', 'Meja', 'Bola', 'Kucing', 'Rumah', 'Apel', 'Ibu', 'Ayah'];
        words.forEach(word => {
            bacaContainer.innerHTML += `
                <div class="bg-white rounded-lg shadow p-4 flex flex-col items-center justify-center">
                    <p class="text-3xl font-bold text-gray-800 mb-2">${word}</p>
                    <button data-text="${word}" class="baca-btn bg-indigo-500 text-white rounded-full p-2 hover:bg-indigo-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    </button>
                </div>
            `;
        });
    };
    
    const setActiveNav = (activeTab) => {
        document.querySelectorAll('.tab-btn.active, .menu-item.active, .menu-item-group-toggle.active-parent').forEach(el => {
            el.classList.remove('active', 'active-parent');
        });
        belajarSubmenu.classList.remove('open');

        document.querySelectorAll(`.tab-btn[data-tab="${activeTab}"]`).forEach(btn => btn.classList.add('active'));
        document.querySelectorAll(`.menu-item[data-tab="${activeTab}"]`).forEach(btn => btn.classList.add('active'));
        
        if (activeTab && (activeTab.startsWith('belajar-') || activeTab === 'game-lobby')) {
            belajarMenuToggle.classList.add('active-parent');
            belajarSubmenu.classList.add('open');
            const subItem = belajarSubmenu.querySelector(`.submenu-item[data-tab="${activeTab}"]`);
            if(subItem) subItem.classList.add('active');
        }
    };

    const showTabPane = (activeTab) => {
        tabPanes.forEach(pane => pane.classList.toggle('hidden', pane.id !== `${activeTab}-view`));
    };

    const handleNavClick = (e) => {
        const navButton = e.target.closest('.tab-btn, .menu-item');
        if (!navButton) return;
        
        const tabToShow = navButton.dataset.tab;
        if(tabToShow) {
            setActiveNav(tabToShow);
            showTabPane(tabToShow);
        }
    };
    
    const renderAgenda = () => {
        scheduleAgenda.innerHTML = '';
        const todayName = daysOfWeek[new Date().getDay()];
        const scheduleByDay = {};
        students.forEach(student => {
            if (student.schedule) {
                const dayName = student.schedule.split(',')[0].trim();
                if (!scheduleByDay[dayName]) scheduleByDay[dayName] = [];
                scheduleByDay[dayName].push(student);
            }
        });
        let agendaHTML = '<div class="space-y-6">';
        daysOfWeek.forEach(day => {
            const isToday = day === todayName;
            const dayHeaderClass = isToday ? 'text-indigo-600 font-bold border-indigo-500' : 'text-gray-800 font-semibold border-gray-200';
            agendaHTML += `<div><h3 class="text-lg ${dayHeaderClass} mb-3 pb-2 border-b-2">${day}</h3>`;
            const scheduledStudents = scheduleByDay[day] || [];
            if (scheduledStudents.length > 0) {
                scheduledStudents.sort((a, b) => (a.schedule.split(',')[1]?.trim() || '00:00').localeCompare(b.schedule.split(',')[1]?.trim() || '00:00'));
                agendaHTML += '<ul class="space-y-3">';
                scheduledStudents.forEach(student => {
                    const time = student.schedule.split(',')[1]?.trim();
                    if (!time) return;
                    const timeParts = time.split(':');
                    const endTimeHour = (parseInt(timeParts[0]) + 1).toString().padStart(2, '0');
                    const endTime = `${endTimeHour}:${timeParts[1]}`;
                    let membersHtml = student.lessonType === 'Grup' && student.members?.length ? `<p class="text-xs text-gray-500 truncate">${student.members.join(', ')}</p>` : '';
                    agendaHTML += `
                        <li class="flex items-center gap-3 p-2 rounded-lg transition-colors hover:bg-indigo-50">
                            <div class="font-semibold text-gray-700 w-32 text-center bg-gray-100 rounded py-2 px-2">${time} - ${endTime}</div>
                            <div class="flex-1 overflow-hidden"><p class="font-medium text-gray-900 truncate">${student.name}</p>${membersHtml}<p class="text-sm text-indigo-600">${student.subject} <span class="text-gray-500 font-normal">(${student.lessonType || 'Privat'})</span></p></div>
                        </li>`;
                });
                agendaHTML += '</ul>';
            } else {
                agendaHTML += '<p class="text-sm text-gray-500 pl-2">Tidak ada jadwal.</p>';
            }
            agendaHTML += '</div>';
        });
        agendaHTML += '</div>';
        scheduleAgenda.innerHTML = agendaHTML;
    };


    const renderStudents = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = lessonTypeFilter.value;
        const filteredStudents = students.filter(student => {
            const typeMatch = selectedType === 'Semua' || student.lessonType === selectedType;
            const searchMatch = student.name.toLowerCase().includes(searchTerm) || (student.members && student.members.join(' ').toLowerCase().includes(searchTerm));
            return typeMatch && searchMatch;
        });

        studentList.innerHTML = ''; 
        if (students.length === 0) {
            emptyState.classList.remove('hidden');
            emptyState.querySelector('h3').textContent = 'Belum Ada Jadwal';
            emptyState.querySelector('p').textContent = 'Silakan tambahkan jadwal les baru untuk memulai.';
        } else if (filteredStudents.length === 0) {
            emptyState.classList.remove('hidden');
            emptyState.querySelector('h3').textContent = 'Jadwal Tidak Ditemukan';
            emptyState.querySelector('p').textContent = 'Tidak ada jadwal yang cocok dengan filter atau pencarian Anda.';
        } else {
            emptyState.classList.add('hidden');
        }

        filteredStudents.forEach(student => {
            const lessonTypeColors = { 'Privat': 'bg-blue-100 text-blue-800', 'Grup': 'bg-purple-100 text-purple-800', 'Visit Home': 'bg-yellow-100 text-yellow-800' };
            const lessonType = student.lessonType || 'Privat';
            const lessonTypeBadge = `<span class="text-xs font-semibold px-2.5 py-1 rounded-full ${lessonTypeColors[lessonType]}">${lessonType}</span>`;
            let membersHtml = lessonType === 'Grup' && student.members?.length ? `<p class="text-sm text-gray-600 mt-1 truncate">${student.members.join(', ')}</p>` : '';
            
            let startDateHtml = '';
            if (student.startDate) {
                const formattedDate = new Date(student.startDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                startDateHtml = `<div class="flex items-center gap-3 text-gray-600 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-2"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 14V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M3 10h18"/><path d="m16 20 2 2 4-4"/></svg><span>Mulai: ${formattedDate}</span></div>`;
            }
            
            const actionButtons = `<div class="mt-5 flex justify-end gap-3"><button class="edit-btn text-blue-600 hover:text-blue-800 font-semibold" data-id="${student.id}">Edit</button><button class="delete-btn text-red-600 hover:text-red-800 font-semibold" data-id="${student.id}">Hapus</button></div>`;

            const studentCard = `
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl hover:border-indigo-500 transition-all duration-300">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 overflow-hidden">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${student.name}</h3>
                            ${membersHtml}
                            <p class="text-indigo-600 font-medium">${student.subject}</p>
                        </div>
                        ${lessonTypeBadge}
                    </div>
                    <div class="mt-4 border-t pt-4 space-y-2">
                        ${startDateHtml}
                        <div class="flex items-center gap-3 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-clock"><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="M18 17a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"/><path d="M18 15v2h2"/></svg>
                            <span>${student.schedule}</span>
                        </div>
                         <p class="text-sm text-gray-500 italic pt-2 h-12 overflow-hidden">${student.notes || 'Tidak ada catatan.'}</p>
                    </div>
                    ${currentUserRole === 'Admin' ? actionButtons : ''}
                </div>`;
            studentList.innerHTML += studentCard;
        });
    };
    
    const updateUI = () => {
        renderStudents();
        renderAgenda();
        renderAttendance(attendanceDatePicker.value);
        renderRecap();
        renderLaporan();
        renderHuruf();
        renderBaca();
        if (currentUserRole === 'Admin') renderUsers();
    };
    
    const showModal = (options = {}) => {
        const { isEdit = false, student = null } = options;
        studentForm.reset();
        accountCreationError.classList.add('hidden');
        parentPasswordFields.classList.add('hidden');
        document.getElementById('student-id').value = '';

        if (isEdit && student) {
            modalTitle.textContent = 'Edit Data Jadwal';
            document.getElementById('student-id').value = student.id;
            document.getElementById('lesson-type').value = student.lessonType || 'Privat';
            toggleModalFields();
            document.getElementById('name').value = student.name;
            document.getElementById('subject').value = student.subject;
            document.getElementById('notes').value = student.notes;
            document.getElementById('start-date').value = student.startDate || '';
            parentAccountCreator.classList.add('hidden'); 
            if (student.lessonType === 'Grup' && student.members) {
                student.members.forEach((member, index) => {
                    const memberInput = document.getElementById(`group-member-${index + 1}`);
                    if (memberInput) memberInput.value = member;
                });
            }
            if (student.schedule && student.schedule.includes(',')) {
                const [day, time] = student.schedule.split(',').map(s => s.trim());
                document.getElementById('schedule-day').value = day;
                document.getElementById('schedule-time').value = time;
            }
        } else {
            modalTitle.textContent = 'Tambah Jadwal Baru';
            lessonTypeSelect.value = 'Privat';
            toggleModalFields();
        }
        studentModal.classList.remove('hidden');
    };

    const hideModal = () => studentModal.classList.add('hidden');
    
    const showFeedback = (isCorrect) => {
        if(isCorrect) {
            feedbackText.textContent = 'Benar! 🎉';
            speak('Benar!');
            feedbackText.className = 'font-fredoka text-5xl md:text-6xl text-green-500';
        } else {
            feedbackText.textContent = 'Coba lagi!';
            speak('Coba lagi!');
            feedbackText.className = 'font-fredoka text-5xl md:text-6xl text-red-500';
        }
        
        feedbackModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
        feedbackModal.classList.add('opacity-100', 'scale-100');

        setTimeout(() => {
            feedbackModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            feedbackModal.classList.remove('opacity-100', 'scale-100');
        }, 1200);
    };

    // Fungsi Game
    const initAngkaGame = () => {
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);
        const allQuestions = [
            { name: 'pisang', icon: '🍌', count: 4 }, { name: 'nanas', icon: '🍍', count: 2 }, { name: 'semangka', icon: '🍉', count: 1 },
            { name: 'stroberi', icon: '🍓', count: 5 }, { name: 'jeruk', icon: '🍊', count: 3 }, { name: 'apel', icon: '🍎', count: 6 },
            { name: 'kucing', icon: '🐈', count: 2 }, { name: 'anjing', icon: '🐕', count: 3 }, { name: 'burung', icon: '🐦', count: 5 },
            { name: 'ikan', icon: '🐟', count: 7 }, { name: 'mobil', icon: '🚗', count: 4 }, { name: 'sepeda', icon: '🚲', count: 1 },
            { name: 'bintang', icon: '⭐', count: 8 }, { name: 'hati', icon: '💖', count: 6 }, { name: 'pizza', icon: '🍕', count: 3 },
            { name: 'donat', icon: '🍩', count: 9 }, { name: 'balon', icon: '🎈', count: 10 }, { name: 'buku', icon: '📚', count: 5 },
            { name: 'pensil', icon: '✏️', count: 7 }, { name: 'bola', icon: '⚽', count: 1 }
        ];
        
        gameQuestions = shuffleArray(allQuestions);
        currentQuestionIndex = 0;
        
        gameActiveView.innerHTML = `
            <button id="back-to-lobby-btn" class="flex items-center gap-2 mb-4 text-indigo-600 font-semibold hover:text-indigo-800">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left-circle"><circle cx="12" cy="12" r="10"/><path d="M16 12H8"/><path d="m12 8-4 4 4 4"/></svg>
                Kembali ke Pilihan Game
            </button>
            <div class="text-center mb-8">
                <h1 class="font-fredoka text-4xl text-blue-600">Mari Berhitung!</h1>
                <p class="text-gray-500 mt-2">Pilih angka yang sesuai dengan jumlah benda.</p>
            </div>
            <div id="game-container-berhitung" class="w-full max-w-lg mx-auto min-h-[350px]"></div>
            <div id="game-nav-container" class="flex items-center justify-between max-w-lg mx-auto mt-6">
                <button id="prev-question-btn" class="bg-white rounded-full p-3 shadow-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                </button>
                <p id="game-progress" class="font-semibold text-gray-600 text-lg"></p>
                <button id="next-question-btn" class="bg-indigo-500 text-white rounded-full p-3 shadow-md hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </div>
            <div id="game-end-screen" class="hidden text-center mt-8">
                 <h2 class="font-fredoka text-4xl text-green-500">Selesai! Hebat! 🎉</h2>
                 <p class="text-gray-600 mt-2">Kamu sudah menyelesaikan semua soal.</p>
                 <button id="restart-game-btn" class="mt-4 bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-indigo-600 transition-transform hover:scale-105">Ulangi Permainan</button>
            </div>
        `;
        renderCurrentQuestion();
    };

    const renderCurrentQuestion = () => {
        const gameContainer = document.getElementById('game-container-berhitung');
        const gameNav = document.getElementById('game-nav-container');
        const gameEnd = document.getElementById('game-end-screen');

        if (currentQuestionIndex >= gameQuestions.length) {
            if (gameNav) gameNav.classList.add('hidden');
            if (gameContainer) gameContainer.innerHTML = '';
            if (gameEnd) gameEnd.classList.remove('hidden');
            speak('Selesai! Hebat!');
            return;
        }

        const q = gameQuestions[currentQuestionIndex];
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);
        const generateOptions = (correctAnswer) => {
            let options = new Set([correctAnswer]);
            while (options.size < 3) {
                let randomOption = Math.floor(Math.random() * 10) + 1;
                if(randomOption !== correctAnswer) options.add(randomOption);
            }
            return shuffleArray(Array.from(options));
        };
        
        const options = generateOptions(q.count);
        const objectDisplay = q.icon.repeat(q.count);
        if(gameContainer) {
            gameContainer.innerHTML = `
                <div class="game-card p-6 flex flex-col items-center gap-4">
                    <div class="game-object-display text-center">${objectDisplay}</div>
                    <div class="w-full flex justify-center gap-3">
                        ${options.map(opt => `
                            <button class="game-option-btn w-16 h-16 font-fredoka text-3xl text-white rounded-full shadow-md bg-blue-500 hover:bg-blue-600" data-value="${opt}">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        updateGameNavigation();
        setTimeout(() => speak(`Berapa jumlah ${q.name}?`), 500);
    };
    
    const updateGameNavigation = () => {
        const progressEl = document.getElementById('game-progress');
        const prevButton = document.getElementById('prev-question-btn');
        const nextButton = document.getElementById('next-question-btn');
        if (progressEl) progressEl.textContent = `Soal ${currentQuestionIndex + 1} dari ${gameQuestions.length}`;
        if (prevButton) prevButton.disabled = currentQuestionIndex === 0;
        if (nextButton) nextButton.disabled = currentQuestionIndex >= gameQuestions.length -1;
    };


    // Event Listeners
    addStudentBtn.addEventListener('click', () => showModal({}));
    cancelBtn.addEventListener('click', hideModal);
    studentModal.addEventListener('click', (e) => { if (e.target === studentModal) hideModal(); });

    studentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        accountCreationError.classList.add('hidden');
        
        const createAccount = createParentAccountCheckbox.checked;
        const studentName = nameInput.value.trim();
        const id = document.getElementById('student-id').value;

        if (!id && createAccount) {
            const parentPassword = document.getElementById('parent-password').value;
            const parentConfirmPassword = document.getElementById('parent-confirm-password').value;

            if (!parentPassword || parentPassword !== parentConfirmPassword) {
                accountCreationError.textContent = 'Password tidak cocok atau kosong.';
                accountCreationError.classList.remove('hidden');
                return;
            }
            if (users.some(u => u.username.toLowerCase() === studentName.toLowerCase())) {
                accountCreationError.textContent = `Username "${studentName}" sudah digunakan.`;
                accountCreationError.classList.remove('hidden');
                return;
            }
            
            users.push({ username: studentName, password: parentPassword, role: 'OrangTua' });
            saveUsers();
        }
        
        const lessonType = lessonTypeSelect.value;
        const studentData = {
            name: studentName,
            lessonType: lessonType,
            subject: document.getElementById('subject').value,
            startDate: document.getElementById('start-date').value,
            schedule: `${document.getElementById('schedule-day').value}, ${document.getElementById('schedule-time').value}`,
            notes: document.getElementById('notes').value,
            members: [],
            learningReport: '' 
        };
        if (lessonType === 'Grup') {
            studentData.members = [
                document.getElementById('group-member-1').value,
                document.getElementById('group-member-2').value,
                document.getElementById('group-member-3').value,
            ].filter(Boolean);
        }
        if (id) {
            const index = students.findIndex(s => s.id == id);
            if (index !== -1) {
                studentData.attendance = students[index].attendance || [];
                studentData.learningReport = students[index].learningReport || '';
                students[index] = { ...students[index], ...studentData };
            }
        } else {
            studentData.id = Date.now();
            students.push(studentData);
        }
        saveStudents();
        updateUI();
        hideModal();
    });

    studentList.addEventListener('click', (e) => {
        const target = e.target;
        const id = target.dataset.id;
        if (target.classList.contains('edit-btn')) {
            const studentToEdit = students.find(s => s.id == id);
            if (studentToEdit) showModal({ isEdit: true, student: studentToEdit });
        }
        if (target.classList.contains('delete-btn')) {
            students = students.filter(s => s.id != id);
            saveStudents();
            updateUI();
        }
    });
    
    menuToggleBtn.addEventListener('click', () => mainLayout.classList.toggle('sidebar-collapsed'));
    searchInput.addEventListener('input', renderStudents);
    lessonTypeFilter.addEventListener('change', renderStudents);
    tabsContainer.addEventListener('click', handleNavClick);
    sideMenu.addEventListener('click', handleNavClick);
    
    belajarMenuToggle.addEventListener('click', () => {
        belajarMenuToggle.classList.toggle('active-parent');
        belajarSubmenu.classList.toggle('open');
    });

    attendanceDatePicker.addEventListener('change', () => renderAttendance(attendanceDatePicker.value));
    
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginError.classList.add('hidden');
        const username = usernameInput.value;
        const password = passwordInput.value;

        const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
        
        if (user) {
            const sessionData = { role: user.role, childName: user.role === 'OrangTua' ? user.username : '' };
            sessionStorage.setItem('loggedInUser', JSON.stringify(sessionData));
            currentUserRole = sessionData.role;
            currentChildNameForParent = sessionData.childName;
            
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('rememberedUser', JSON.stringify({ username: username, password: password }));
            } else {
                localStorage.removeItem('rememberedUser');
            }

            showApp();
        } else {
            loginError.textContent = 'Username atau password salah.';
            loginError.classList.remove('hidden');
        }
    });

    logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('loggedInUser');
        currentUserRole = '';
        currentChildNameForParent = '';
        location.reload();
    });

    attendanceListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('attendance-btn')) {
            const isActionable = currentUserRole === 'Admin' || currentUserRole === 'Guru';
            if (!isActionable) return;

            const studentId = e.target.dataset.id;
            const status = e.target.dataset.status;
            const attendanceDate = attendanceDatePicker.value;
            const student = students.find(s => s.id == studentId);
            if (!student) return;
            student.attendance = student.attendance || [];
            const attendanceIndex = student.attendance.findIndex(att => att.date === attendanceDate);
            if (attendanceIndex > -1) {
                if (student.attendance[attendanceIndex].status === status) {
                    student.attendance.splice(attendanceIndex, 1);
                } else {
                    student.attendance[attendanceIndex].status = status;
                }
            } else {
                student.attendance.push({ date: attendanceDate, status: status });
            }
            saveStudents();
            renderAttendance(attendanceDate);
        }
    });

    userForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newUsername = document.getElementById('new-username').value.trim();
        const newPassword = document.getElementById('new-password').value;
        const newRole = document.getElementById('new-role').value;

        if (!newUsername || !newPassword) {
            alert('Username dan password tidak boleh kosong!');
            return;
        }

        if (users.some(u => u.username.toLowerCase() === newUsername.toLowerCase())) {
            alert('Username sudah digunakan!');
            return;
        }

        users.push({ username: newUsername, password: newPassword, role: newRole });
        saveUsers();
        renderUsers();
        userForm.reset();
        usernameHint.classList.add('hidden');
    });
    
    newRoleSelect.addEventListener('change', (e) => {
        usernameHint.classList.toggle('hidden', e.target.value !== 'OrangTua');
    });

    userList.addEventListener('click', (e) => {
        if(e.target.classList.contains('delete-user-btn')) {
            const usernameToDelete = e.target.dataset.username;
            users = users.filter(u => u.username !== usernameToDelete);
            saveUsers();
            renderUsers();
        }
    });
    
    lessonTypeSelect.addEventListener('change', toggleModalFields);
    createParentAccountCheckbox.addEventListener('change', () => {
        parentPasswordFields.classList.toggle('hidden', !createParentAccountCheckbox.checked);
        accountCreationError.classList.add('hidden');
    });
    
    laporanListContainer.addEventListener('input', (e) => {
        if(e.target.classList.contains('laporan-textarea')) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const studentId = e.target.dataset.id;
                const student = students.find(s => s.id == studentId);
                if (student) {
                    student.learningReport = e.target.value;
                    saveStudents();
                }
            }, 500);
        }
    });

    document.getElementById('tab-content').addEventListener('click', (e) => {
        if (e.target.classList.contains('belajar-btn')) {
            speak(e.target.textContent);
        }
        if (e.target.closest('.baca-btn')) {
            speak(e.target.closest('.baca-btn').dataset.text);
        }
    });
    
    gameActiveView.addEventListener('click', (e) => {
        const target = e.target;
        if (target.closest('#back-to-lobby-btn')) {
            gameLobby.classList.remove('hidden');
            gameActiveView.classList.add('hidden');
            gameActiveView.innerHTML = '';
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }
        
        if (target.classList.contains('game-option-btn')) {
            const card = target.closest('.game-card');
            if(card && !card.classList.contains('answered')) {
                const selectedAnswer = parseInt(target.dataset.value, 10);
                const correctAnswer = gameQuestions[currentQuestionIndex].count;
                if (selectedAnswer === correctAnswer) {
                    showFeedback(true);
                    card.classList.add('correct-answer-animation');
                    card.classList.add('answered');
                    card.querySelectorAll('.game-option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (parseInt(btn.dataset.value, 10) !== correctAnswer) {
                            btn.classList.add('opacity-50');
                        } else {
                            btn.classList.remove('bg-blue-500');
                            btn.classList.add('bg-green-500');
                        }
                    });
                } else {
                    showFeedback(false);
                    target.style.animation = 'game-shake 0.4s';
                    setTimeout(() => { target.style.animation = ''; }, 400);
                }
            }
        }

        if (target.closest('#prev-question-btn')) {
             if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderCurrentQuestion();
            }
        }
        if (target.closest('#next-question-btn')) {
             if (currentQuestionIndex < gameQuestions.length) {
                currentQuestionIndex++;
                renderCurrentQuestion();
            }
        }
        if (target.closest('#restart-game-btn')) {
            initAngkaGame();
        }
    });
    
    gameLobby.addEventListener('click', (e) => {
        const gameButton = e.target.closest('[data-game]');
        if (gameButton && gameButton.dataset.game === 'berhitung') {
            gameLobby.classList.add('hidden');
            gameActiveView.classList.remove('hidden');
            initAngkaGame();
        } else if (gameButton && gameButton.dataset.game === 'wortel') {
             // Logic to start carrot game will be added here
        }
    });

    // Inisialisasi
    loadData();
});
</script>
</body>
</html>

